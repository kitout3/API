<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion d'√âmargement - √âv√©nements</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Utilitaires de stockage
        const Storage = {
            getEvents: () => {
                const data = localStorage.getItem('events');
                return data ? JSON.parse(data) : [];
            },
            saveEvents: (events) => {
                localStorage.setItem('events', JSON.stringify(events));
            },
            getParticipants: (eventId) => {
                const data = localStorage.getItem(`participants_${eventId}`);
                return data ? JSON.parse(data) : [];
            },
            saveParticipants: (eventId, participants) => {
                localStorage.setItem(`participants_${eventId}`, JSON.stringify(participants));
            }
        };

        // Composant principal
        function App() {
            const [view, setView] = useState('home');
            const [events, setEvents] = useState([]);
            const [currentEvent, setCurrentEvent] = useState(null);

            useEffect(() => {
                setEvents(Storage.getEvents());
            }, []);

            const saveEvents = (newEvents) => {
                Storage.saveEvents(newEvents);
                setEvents(newEvents);
            };

            const createEvent = (eventData) => {
                const newEvent = {
                    id: Date.now().toString(),
                    ...eventData,
                    createdAt: new Date().toISOString()
                };
                saveEvents([...events, newEvent]);
                return newEvent;
            };

            const deleteEvent = (eventId) => {
                if (confirm('√ätes-vous s√ªr de vouloir supprimer cet √©v√©nement ?')) {
                    saveEvents(events.filter(e => e.id !== eventId));
                    localStorage.removeItem(`participants_${eventId}`);
                }
            };

            if (view === 'home') {
                return <HomePage 
                    events={events} 
                    onCreateEvent={() => setView('create')}
                    onViewEvent={(event) => {
                        setCurrentEvent(event);
                        setView('detail');
                    }}
                    onDeleteEvent={deleteEvent}
                />;
            }

            if (view === 'create') {
                return <CreateEventPage 
                    onBack={() => setView('home')}
                    onCreate={(eventData) => {
    const newEvent = createEvent(eventData);
    setCurrentEvent(newEvent);
    setView('detail');
    return newEvent;
}}
                />;
            }

            if (view === 'detail' && currentEvent) {
                return <EventDetailPage 
                    event={currentEvent}
                    onBack={() => {
                        setView('home');
                        setCurrentEvent(null);
                    }}
                    onScanQR={() => setView('scanner')}
                />;
            }

            if (view === 'scanner' && currentEvent) {
                return <QRScannerPage 
                    event={currentEvent}
                    onBack={() => setView('detail')}
                />;
            }

            return null;
        }

        // Page d'accueil
        function HomePage({ events, onCreateEvent, onViewEvent, onDeleteEvent }) {
            const [search, setSearch] = useState('');
            const [statusFilter, setStatusFilter] = useState('all');

            const getEventStatus = (event) => {
                const now = new Date();
                const eventDate = new Date(event.date);
                const dayDiff = Math.floor((eventDate - now) / (1000 * 60 * 60 * 24));

                if (dayDiff < 0) return 'termin√©';
                if (dayDiff === 0) return 'en cours';
                return '√† venir';
            };

            const filteredEvents = events.filter(event => {
                const matchSearch = event.name.toLowerCase().includes(search.toLowerCase()) ||
                                  (event.lieu || '').toLowerCase().includes(search.toLowerCase());
                const matchStatus = statusFilter === 'all' || getEventStatus(event) === statusFilter;
                return matchSearch && matchStatus;
            });

            return (
                <div className="min-h-screen bg-gray-50">
                    <div className="max-w-7xl mx-auto p-6">
                        <div className="mb-8">
                            <h1 className="text-3xl font-bold text-gray-900 mb-2">Gestion d'√âmargement</h1>
                            <p className="text-gray-600">G√©rez vos √©v√©nements et suivez les pr√©sences en temps r√©el</p>
                        </div>

                        <div className="bg-white rounded-lg shadow-sm p-6 mb-6">
                            <div className="flex flex-col md:flex-row gap-4 mb-4">
                                <input
                                    type="text"
                                    placeholder="Rechercher un √©v√©nement..."
                                    value={search}
                                    onChange={(e) => setSearch(e.target.value)}
                                    className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                />
                                <select
                                    value={statusFilter}
                                    onChange={(e) => setStatusFilter(e.target.value)}
                                    className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                >
                                    <option value="all">Tous les statuts</option>
                                    <option value="√† venir">√Ä venir</option>
                                    <option value="en cours">En cours</option>
                                    <option value="termin√©">Termin√©</option>
                                </select>
                                <button
                                    onClick={onCreateEvent}
                                    className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
                                >
                                    + Cr√©er un √©v√©nement
                                </button>
                            </div>
                        </div>

                        {filteredEvents.length === 0 ? (
                            <div className="bg-white rounded-lg shadow-sm p-12 text-center">
                                <p className="text-gray-500 text-lg mb-4">Aucun √©v√©nement trouv√©</p>
                                <button
                                    onClick={onCreateEvent}
                                    className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
                                >
                                    Cr√©er votre premier √©v√©nement
                                </button>
                            </div>
                        ) : (
                            <div className="grid gap-4">
                                {filteredEvents.map(event => {
                                    const participants = Storage.getParticipants(event.id);
                                    const presents = participants.filter(p => p.present).length;
                                    const status = getEventStatus(event);
                                    
                                    return (
                                        <div key={event.id} className="bg-white rounded-lg shadow-sm p-6 hover:shadow-md transition">
                                            <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                                                <div className="flex-1">
                                                    <div className="flex items-center gap-3 mb-2">
                                                        <h3 className="text-xl font-semibold text-gray-900">{event.name}</h3>
                                                        <span className={`px-3 py-1 rounded-full text-xs font-medium ${
                                                            status === 'en cours' ? 'bg-green-100 text-green-800' :
                                                            status === '√† venir' ? 'bg-blue-100 text-blue-800' :
                                                            'bg-gray-100 text-gray-800'
                                                        }`}>
                                                            {status}
                                                        </span>
                                                    </div>
                                                    <div className="flex flex-wrap gap-4 text-sm text-gray-600">
                                                        <span>üìÖ {new Date(event.date).toLocaleDateString('fr-FR')}</span>
                                                        {event.lieu && <span>üìç {event.lieu}</span>}
                                                        <span>üë• {participants.length} inscrits</span>
                                                        <span className="text-green-600 font-medium">‚úì {presents} pr√©sents</span>
                                                        {event.capacite && (
                                                            <span>üìä {Math.round((presents / event.capacite) * 100)}% remplissage</span>
                                                        )}
                                                    </div>
                                                </div>
                                                <div className="flex gap-2">
                                                    <button
                                                        onClick={() => onViewEvent(event)}
                                                        className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
                                                    >
                                                        G√©rer
                                                    </button>
                                                    <button
                                                        onClick={() => onDeleteEvent(event.id)}
                                                        className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition"
                                                    >
                                                        Supprimer
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // Page de cr√©ation d'√©v√©nement
        function CreateEventPage({ onBack, onCreate }) {
            const [formData, setFormData] = useState({
                name: '',
                date: '',
                lieu: '',
                capacite: '',
                description: ''
            });
            const [participants, setParticipants] = useState([]);
            const [importing, setImporting] = useState(false);
            const [autoEventName, setAutoEventName] = useState('');

            ubmit = (e) => {
                e.preventDefault();
                const eventName = formData.name || autoEventName;
                if (!eventName || !formData.date) {
                    alert('Veuillez remplir les champs obligatoires (nom et date)');
                    return;
                }
                const event = onCreate({...formData, name: eventName});
                if (participants.length > 0) {
                    Storage.saveParticipants(event.id, participants);
                }
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                setImporting(true);
                const reader = new FileReader();
                
                reader.onload = (evt) => {
                    try {
                        const data = new Uint8Array(evt.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const rows = XLSX.utils.sheet_to_json(firstSheet);

                        // Extraire le nom de l'√©v√©nement depuis la premi√®re ligne
                        if (rows.length > 0 && rows[0]['√âv√©nement']) {
                            const eventName = rows[0]['√âv√©nement'];
                            setAutoEventName(eventName);
                            setFormData({...formData, name: eventName});
                        }

const imported = rows.map((row, index) => {
    const id = row["ID d'inscription"];

    return {
        id_client: id ? String(id).trim() : `GEN_${Date.now()}_${index}`,
        contact: row.Contact || '',
        email: row.Email || row['Adresse email'] || '',
        gerant: row.G√©rant || '',
        source: 'import',
        present: false,
        datePresence: null,
        modeValidation: null
    };
});

                        const uniqueParticipants = imported.filter((p, index, self) =>
                            index === self.findIndex(t => t.id_client === p.id_client)
                        );

                        setParticipants(uniqueParticipants);
                        alert(`${uniqueParticipants.length} participants import√©s avec succ√®s`);
                    } catch (error) {
                        alert('Erreur lors de l\'import du fichier Excel');
                        console.error(error);
                    } finally {
                        setImporting(false);
                    }
                };

                reader.readAsArrayBuffer(file);
            };

            return (
                <div className="min-h-screen bg-gray-50">
                    <div className="max-w-4xl mx-auto p-6">
                        <button onClick={onBack} className="mb-6 text-blue-600 hover:text-blue-700 flex items-center gap-2">
                            ‚Üê Retour √† la liste
                        </button>

                        <div className="bg-white rounded-lg shadow-sm p-8">
                            <h2 className="text-2xl font-bold text-gray-900 mb-6">Cr√©er un nouvel √©v√©nement</h2>

                            <form onSubmit={handleSubmit} className="space-y-6">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Nom de l'√©v√©nement {autoEventName && '(d√©tect√© automatiquement)'}
                                    </label>
                                    <input
                                        type="text"
                                        required
                                        value={formData.name}
                                        onChange={(e) => setFormData({...formData, name: e.target.value})}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                        placeholder={autoEventName ? `Nom d√©tect√©: ${autoEventName}` : 'Nom de l\'√©v√©nement'}
                                    />
                                    {autoEventName && (
                                        <p className="text-sm text-green-600 mt-1">
                                            ‚úì Nom d'√©v√©nement d√©tect√© dans le fichier Excel
                                        </p>
                                    )}
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Date de l'√©v√©nement *
                                    </label>
                                    <input
                                        type="datetime-local"
                                        required
                                        value={formData.date}
                                        onChange={(e) => setFormData({...formData, date: e.target.value})}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Lieu
                                    </label>
                                    <input
                                        type="text"
                                        value={formData.lieu}
                                        onChange={(e) => setFormData({...formData, lieu: e.target.value})}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Capacit√© maximale
                                    </label>
                                    <input
                                        type="number"
                                        value={formData.capacite}
                                        onChange={(e) => setFormData({...formData, capacite: e.target.value})}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Description
                                    </label>
                                    <textarea
                                        value={formData.description}
                                        onChange={(e) => setFormData({...formData, description: e.target.value})}
                                        rows="3"
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>

                                <div className="border-t pt-6">
                                    <h3 className="text-lg font-semibold text-gray-900 mb-4">Importer les inscrits</h3>
                                    <div className="flex items-center gap-4 mb-4">
                                        <label className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 cursor-pointer transition">
                                            üìÅ Choisir un fichier Excel
                                            <input
                                                type="file"
                                                accept=".xlsx,.xls"
                                                onChange={handleFileUpload}
                                                className="hidden"
                                            />
                                        </label>
                                        {importing && (
                                            <span className="text-blue-600 font-medium">
                                                ‚è≥ Import en cours...
                                            </span>
                                        )}
                                        {participants.length > 0 && !importing && (
                                            <span className="text-green-600 font-medium">
                                                ‚úì {participants.length} participants import√©s
                                            </span>
                                        )}
                                    </div>
                                    <p className="text-sm text-gray-500 mb-4">
                                        Le fichier doit contenir : ID d'inscription, Contact, G√©rant, Email
                                    </p>
                                    
                                    {participants.length > 0 && (
                                        <div className="border rounded-lg overflow-hidden">
                                            <div className="bg-gray-50 px-4 py-3 border-b">
                                                <h4 className="font-semibold text-gray-700">Aper√ßu des participants import√©s</h4>
                                            </div>
                                            <div className="max-h-96 overflow-y-auto">
                                                <table className="w-full">
                                                    <thead className="bg-gray-100 sticky top-0">
                                                        <tr>
                                                            <th className="px-4 py-2 text-left text-xs font-medium text-gray-600">ID d'inscription</th>
                                                            <th className="px-4 py-2 text-left text-xs font-medium text-gray-600">Contact</th>
                                                            <th className="px-4 py-2 text-left text-xs font-medium text-gray-600">G√©rant</th>
                                                            <th className="px-4 py-2 text-left text-xs font-medium text-gray-600">Email</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody className="divide-y divide-gray-200">
                                                        {participants.map((p, idx) => (
                                                            <tr key={idx} className="hover:bg-gray-50">
                                                                <td className="px-4 py-2 text-xs text-gray-500 font-mono">{p.id_client}</td>
                                                                <td className="px-4 py-2 text-sm text-gray-900 font-medium">{p.contact}</td>
                                                                <td className="px-4 py-2 text-sm text-gray-600">{p.gerant}</td>
                                                                <td className="px-4 py-2 text-sm text-gray-600">{p.email}</td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                <div className="flex gap-4 pt-6">
                                    <button
                                        type="submit"
                                        className="flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium"
                                    >
                                        Cr√©er l'√©v√©nement
                                    </button>
                                    <button
                                        type="button"
                                        onClick={onBack}
                                        className="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition"
                                    >
                                        Annuler
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            );
        }

        // Page de d√©tail d'√©v√©nement
        function EventDetailPage({ event, onBack, onScanQR }) {
            const [participants, setParticipants] = useState([]);
            const [search, setSearch] = useState('');
            const [filter, setFilter] = useState('all');
            const [showAddForm, setShowAddForm] = useState(false);
            const [newParticipant, setNewParticipant] = useState({
                contact: '',
                gerant: '',
                email: '',
                id_client: ''
            });

            useEffect(() => {
                setParticipants(Storage.getParticipants(event.id));
            }, [event.id]);

            const saveParticipants = (newParticipants) => {
                Storage.saveParticipants(event.id, newParticipants);
                setParticipants(newParticipants);
            };

            const markPresent = (participantId) => {
                const updated = participants.map(p => 
                    p.id_client === participantId && !p.present
                        ? { ...p, present: true, datePresence: new Date().toISOString(), modeValidation: 'manuel' }
                        : p
                );
                saveParticipants(updated);
            };

            const cancelPresence = (participantId) => {
                if (confirm('Annuler l\'√©margement de ce participant ?')) {
                    const updated = participants.map(p => 
                        p.id_client === participantId
                            ? { ...p, present: false, datePresence: null, modeValidation: null }
                            : p
                    );
                    saveParticipants(updated);
                }
            };

            const addParticipant = (markAsPresent) => {
                if (!newParticipant.contact) {
                    alert('Veuillez remplir le nom du contact');
                    return;
                }

                const participant = {
                    id_client: newParticipant.id_client || `MANUAL_${Date.now()}`,
                    contact: newParticipant.contact,
                    email: newParticipant.email,
                    gerant: newParticipant.gerant,
                    source: 'manuel',
                    present: markAsPresent,
                    datePresence: markAsPresent ? new Date().toISOString() : null,
                    modeValidation: markAsPresent ? 'manuel' : null
                };

                saveParticipants([...participants, participant]);
                setNewParticipant({ contact: '', gerant: '', email: '', id_client: '' });
                setShowAddForm(false);
            };

            const exportToExcel = (type) => {
                let dataToExport = participants;
                
                if (type === 'presents') dataToExport = participants.filter(p => p.present);
                else if (type === 'absents') dataToExport = participants.filter(p => !p.present);
                else if (type === 'manuels') dataToExport = participants.filter(p => p.source === 'manuel');

                const ws = XLSX.utils.json_to_sheet(dataToExport.map(p => ({
                    'ID Client': p.id_client,
                    'Contact': p.contact,
                    'G√©rant': p.gerant,
                    'Email': p.email,
                    'Statut': p.present ? 'Pr√©sent' : 'Absent',
                    'Date de pr√©sence': p.datePresence ? new Date(p.datePresence).toLocaleString('fr-FR') : '',
                    'Mode de validation': p.modeValidation || '',
                    'Source': p.source
                })));

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Participants');
                XLSX.writeFile(wb, `${event.name}_${type}_${new Date().toISOString().split('T')[0]}.xlsx`);
            };

            const filteredParticipants = participants.filter(p => {
                const matchSearch = 
                    (p.contact || '').toLowerCase().includes(search.toLowerCase()) ||
                    (p.gerant || '').toLowerCase().includes(search.toLowerCase()) ||
                    (p.email || '').toLowerCase().includes(search.toLowerCase()) ||
                    p.id_client.toLowerCase().includes(search.toLowerCase());
                
                const matchFilter = 
                    filter === 'all' ||
                    (filter === 'present' && p.present) ||
                    (filter === 'absent' && !p.present) ||
                    (filter === 'manual' && p.source === 'manuel');

                return matchSearch && matchFilter;
            });

            const stats = {
                total: participants.length,
                presents: participants.filter(p => p.present).length,
                manuels: participants.filter(p => p.source === 'manuel').length
            };

            return (
                <div className="min-h-screen bg-gray-50">
                    <div className="max-w-7xl mx-auto p-6">
                        <button onClick={onBack} className="mb-6 text-blue-600 hover:text-blue-700 flex items-center gap-2">
                            ‚Üê Retour √† la liste
                        </button>

                        <div className="bg-white rounded-lg shadow-sm p-6 mb-6">
                            <h1 className="text-2xl font-bold text-gray-900 mb-2">{event.name}</h1>
                            <div className="flex flex-wrap gap-4 text-sm text-gray-600 mb-4">
                                <span>üìÖ {new Date(event.date).toLocaleString('fr-FR')}</span>
                                {event.lieu && <span>üìç {event.lieu}</span>}
                            </div>

                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                <div className="bg-blue-50 p-4 rounded-lg">
                                    <div className="text-2xl font-bold text-blue-600">{stats.total}</div>
                                    <div className="text-sm text-gray-600">Inscrits</div>
                                </div>
                                <div className="bg-green-50 p-4 rounded-lg">
                                    <div className="text-2xl font-bold text-green-600">{stats.presents}</div>
                                    <div className="text-sm text-gray-600">Pr√©sents</div>
                                </div>
                                <div className="bg-purple-50 p-4 rounded-lg">
                                    <div className="text-2xl font-bold text-purple-600">
                                        {stats.total > 0 ? Math.round((stats.presents / stats.total) * 100) : 0}%
                                    </div>
                                    <div className="text-sm text-gray-600">Taux de pr√©sence</div>
                                </div>
                                <div className="bg-orange-50 p-4 rounded-lg">
                                    <div className="text-2xl font-bold text-orange-600">{stats.manuels}</div>
                                    <div className="text-sm text-gray-600">Ajouts manuels</div>
                                </div>
                            </div>

                            <div className="flex flex-wrap gap-3">
                                <button
                                    onClick={onScanQR}
                                    className="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-medium"
                                >
                                    üì∑ Scanner QR Code
                                </button>
                                <button
                                    onClick={() => setShowAddForm(!showAddForm)}
                                    className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
                                >
                                    + Ajouter un participant
                                </button>
                                <div className="relative group">
                                    <button className="px-6 py-3 bg-gray-700 text-white rounded-lg hover:bg-gray-800 transition">
                                        üì• Exporter Excel
                                    </button>
                                    <div className="absolute top-full mt-2 right-0 bg-white shadow-lg rounded-lg overflow-hidden hidden group-hover:block z-10">
                                        <button onClick={() => exportToExcel('all')} className="block w-full px-4 py-2 text-left hover:bg-gray-100 whitespace-nowrap">Tous</button>
                                        <button onClick={() => exportToExcel('presents')} className="block w-full px-4 py-2 text-left hover:bg-gray-100">Pr√©sents</button>
                                        <button onClick={() => exportToExcel('absents')} className="block w-full px-4 py-2 text-left hover:bg-gray-100">Absents</button>
                                        <button onClick={() => exportToExcel('manuels')} className="block w-full px-4 py-2 text-left hover:bg-gray-100">Ajouts manuels</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {showAddForm && (
                            <div className="bg-white rounded-lg shadow-sm p-6 mb-6">
                                <h3 className="text-lg font-semibold mb-4">Ajouter un participant</h3>
                                <div className="grid md:grid-cols-2 gap-4 mb-4">
                                    <input
                                        type="text"
                                        placeholder="Contact / Nom *"
                                        value={newParticipant.contact}
                                        onChange={(e) => setNewParticipant({...newParticipant, contact: e.target.value})}
                                        className="px-4 py-2 border border-gray-300 rounded-lg"
                                    />
                                    <input
                                        type="text"
                                        placeholder="G√©rant"
                                        value={newParticipant.gerant}
                                        onChange={(e) => setNewParticipant({...newParticipant, gerant: e.target.value})}
                                        className="px-4 py-2 border border-gray-300 rounded-lg"
                                    />
                                    <input
                                        type="email"
                                        placeholder="Email"
                                        value={newParticipant.email}
                                        onChange={(e) => setNewParticipant({...newParticipant, email: e.target.value})}
                                        className="px-4 py-2 border border-gray-300 rounded-lg"
                                    />
                                    <input
                                        type="text"
                                        placeholder="ID Client (optionnel)"
                                        value={newParticipant.id_client}
                                        onChange={(e) => setNewParticipant({...newParticipant, id_client: e.target.value})}
                                        className="px-4 py-2 border border-gray-300 rounded-lg"
                                    />
                                </div>
                                <div className="flex gap-3">
                                    <button
                                        onClick={() => addParticipant(true)}
                                        className="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                                    >
                                        Ajouter et marquer pr√©sent
                                    </button>
                                    <button
                                        onClick={() => addParticipant(false)}
                                        className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                                    >
                                        Ajouter sans marquer pr√©sent
                                    </button>
                                    <button
                                        onClick={() => setShowAddForm(false)}
                                        className="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300"
                                    >
                                        Annuler
                                    </button>
                                </div>
                            </div>
                        )}

                        <div className="bg-white rounded-lg shadow-sm p-6">
                            <div className="flex flex-col md:flex-row gap-4 mb-6">
                                <input
                                    type="text"
                                    placeholder="Rechercher un participant..."
                                    value={search}
                                    onChange={(e) => setSearch(e.target.value)}
                                    className="flex-1 px-4 py-2 border border-gray-300 rounded-lg"
                                />
                                <select
                                    value={filter}
                                    onChange={(e) => setFilter(e.target.value)}
                                    className="px-4 py-2 border border-gray-300 rounded-lg"
                                >
                                    <option value="all">Tous</option>
                                    <option value="present">Pr√©sents</option>
                                    <option value="absent">Absents</option>
                                    <option value="manual">Ajouts manuels</option>
                                </select>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {filteredParticipants.map(p => (
                                    <div key={p.id_client} className="bg-white border-2 border-gray-200 rounded-lg p-4 hover:shadow-lg hover:border-blue-300 transition">
                                        <div className="mb-3">
                                            <h4 className="font-bold text-gray-900 text-lg mb-2">
                                                {p.contact}
                                            </h4>
                                            {p.gerant && (
                                                <p className="text-sm text-gray-700 mb-1 flex items-center gap-1">
                                                    <span className="font-medium">üë§ G√©rant:</span> {p.gerant}
                                                </p>
                                            )}
                                            {p.email && (
                                                <p className="text-sm text-gray-700 mb-1 flex items-center gap-1">
                                                    <span className="font-medium">‚úâÔ∏è Email:</span> {p.email}
                                                </p>
                                            )}
                                            <p className="text-xs text-gray-400 mt-2 font-mono">
                                                ID: {p.id_client}
                                            </p>
                                        </div>
                                        
                                        <div className="mb-3 pt-3 border-t border-gray-200">
                                            {p.present ? (
                                                <div>
                                                    <span className="inline-block px-3 py-1 text-xs font-semibold text-green-800 bg-green-100 rounded-full">
                                                        ‚úì Pr√©sent
                                                    </span>
                                                    <div className="text-xs text-gray-500 mt-2">
                                                        üìÖ {new Date(p.datePresence).toLocaleString('fr-FR')}
                                                    </div>
                                                    <div className="text-xs text-gray-500">
                                                        üîñ {p.modeValidation}
                                                    </div>
                                                </div>
                                            ) : (
                                                <span className="inline-block px-3 py-1 text-xs font-semibold text-gray-600 bg-gray-100 rounded-full">
                                                    Absent
                                                </span>
                                            )}
                                        </div>

                                        <div className="flex gap-2">
                                            {p.present ? (
                                                <button
                                                    onClick={() => cancelPresence(p.id_client)}
                                                    className="flex-1 px-3 py-2 text-sm text-white bg-red-600 hover:bg-red-700 rounded-lg transition font-medium"
                                                >
                                                    Annuler √©margement
                                                </button>
                                            ) : (
                                                <button
                                                    onClick={() => markPresent(p.id_client)}
                                                    className="flex-1 px-3 py-2 text-sm text-white bg-green-600 hover:bg-green-700 rounded-lg transition font-medium"
                                                >
                                                    Marquer pr√©sent
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>

                            {filteredParticipants.length === 0 && (
                                <div className="text-center py-12 text-gray-500">
                                    Aucun participant trouv√©
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // Page scanner QR
        function QRScannerPage({ event, onBack }) {
            const [scanning, setScanning] = useState(false);
            const [lastScan, setLastScan] = useState(null);
            const [message, setMessage] = useState('');
            const [messageType, setMessageType] = useState('');
            const scannerRef = useRef(null);

            useEffect(() => {
                startScanner();
                return () => {
                    if (scannerRef.current) {
                        scannerRef.current.stop();
                    }
                };
            }, []);

            const startScanner = () => {
                const html5QrCode = new Html5Qrcode("qr-reader");
                scannerRef.current = html5QrCode;

                html5QrCode.start(
                    { facingMode: "environment" },
                    { fps: 10, qrbox: { width: 250, height: 250 } },
                    (decodedText) => {
                        handleScan(decodedText);
                    }
                ).catch(err => {
                    console.error("Erreur scanner:", err);
                    setMessage("Impossible d'acc√©der √† la cam√©ra");
                    setMessageType("error");
                });

                setScanning(true);
            };

            can = (idClient) => {
                const participants = Storage.getParticipants(event.id);
 const scannedId = String(idClient).trim();

const participant = participants.find(
    p => String(p.id_client).trim() === scannedId
);


                if (!participant) {
                    setMessage(`‚ùå ID d'inscription "${idClient}" non trouv√© dans la liste`);
                    setMessageType('error');
                    setLastScan({ idClient, status: 'unknown' });
                    return;
                }

                if (participant.present) {
                    setMessage(`‚ö†Ô∏è ${participant.contact} d√©j√† √©marg√© le ${new Date(participant.datePresence).toLocaleString('fr-FR')}`);
                    setMessageType('warning');
                    setLastScan({ ...participant, status: 'duplicate' });
                    return;
                }

                const updated = participants.map(p => 
                    String(p.id_client).trim() === scannedId
                        ? { ...p, present: true, datePresence: new Date().toISOString(), modeValidation: 'qr' }
                        : p
                );
                
                Storage.saveParticipants(event.id, updated);
                
                setMessage(`‚úÖ ${participant.contact} √©marg√© avec succ√®s !`);
                setMessageType('success');
                setLastScan({ ...participant, status: 'success' });

                setTimeout(() => {
                    setMessage('');
                    setLastScan(null);
                }, 3000);
            };

            return (
                <div className="min-h-screen bg-gray-900">
                    <div className="max-w-4xl mx-auto p-6">
                        <button 
                            onClick={onBack} 
                            className="mb-6 text-white hover:text-gray-300 flex items-center gap-2"
                        >
                            ‚Üê Retour √† l'√©v√©nement
                        </button>

                        <div className="bg-white rounded-lg shadow-xl p-6 mb-6">
                            <h2 className="text-2xl font-bold text-gray-900 mb-2">Scanner QR Code</h2>
                            <p className="text-gray-600 mb-4">{event.name}</p>

                            <div className="bg-gray-900 rounded-lg overflow-hidden mb-4">
                                <div id="qr-reader" className="w-full"></div>
                            </div>

                            {message && (
                                <div className={`p-4 rounded-lg mb-4 ${
                                    messageType === 'success' ? 'bg-green-100 text-green-800' :
                                    messageType === 'warning' ? 'bg-yellow-100 text-yellow-800' :
                                    'bg-red-100 text-red-800'
                                }`}>
                                    <p className="text-lg font-semibold">{message}</p>
                                </div>
                            )}

                            <div className="text-center text-gray-600">
                                <p>Pr√©sentez le QR code devant la cam√©ra</p>
                                <p className="text-sm mt-2">Le scan se fait automatiquement</p>
                            </div>
                        </div>

                        <div className="bg-white rounded-lg shadow-lg p-6">
                            <h3 className="text-lg font-semibold mb-4">Statistiques en temps r√©el</h3>
                            {(() => {
                                const participants = Storage.getParticipants(event.id);
                                const presents = participants.filter(p => p.present).length;
                                return (
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="text-center p-4 bg-blue-50 rounded-lg">
                                            <div className="text-3xl font-bold text-blue-600">{participants.length}</div>
                                            <div className="text-sm text-gray-600">Inscrits</div>
                                        </div>
                                        <div className="text-center p-4 bg-green-50 rounded-lg">
                                            <div className="text-3xl font-bold text-green-600">{presents}</div>
                                            <div className="text-sm text-gray-600">Pr√©sents</div>
                                        </div>
                                    </div>
                                );
                            })()}
                        </div>
                    </div>
                </div>
            );
        }

        // Rendu de l'application
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
